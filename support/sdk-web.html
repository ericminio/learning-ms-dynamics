<!DOCTYPE html>
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Fetch Xml</title>
        <style>
            label, button {
                display: block;
                margin-top: 10px;
            }
            .success {
                background-color: rgb(199, 228, 169);
                color: white;
            }
            .error {
                background-color: red;
                color: white;
            }
        </style>

        <script>
            let send = (options)=> {
                return new Promise((resolve, reject)=> {
                    var request = new window.XMLHttpRequest()
                    request.open(options.method, encodeURI(`${options.uri}/${options.entityNamePlural}`), true)
                    request.setRequestHeader("OData-MaxVersion", "4.0");
                    request.setRequestHeader("OData-Version", "4.0");
                    request.setRequestHeader("Accept", "application/json");
                    request.setRequestHeader("Content-Type", "application/json; charset=utf-8");
                    request.setRequestHeader("Prefer", "odata.maxpagesize=10");
                    request.onreadystatechange = function () {
                        if (this.readyState === 4) {
                            request.onreadystatechange = null;
                            switch (this.status) {
                                case 200:
                                case 204:
                                    resolve(this);
                                    break;
                                default:
                                    var error;
                                    try {
                                        error = JSON.parse(request.response).error;
                                    } catch (e) {
                                        error = new Error("Unexpected Error");
                                    }
                                    reject(error);
                                    break;
                            }
                        }
                    };
                    if (options.data) { request.send(JSON.stringify(options.data)) }
                    else { request.send() }
                })
            }

            let execute = async (document)=> {
                let entityNamePlural = document.querySelector('#entityNamePlural').value
                console.log(entityNamePlural);
                let method = document.querySelector('#method').value
                console.log(method);
                let data = JSON.parse(document.querySelector('#data').value)
                console.log(data);

                var uri = `${window.location.origin}/api/data/v9.0/`
                let result = await send({
                    method:method,
                    uri:uri,
                    entityNamePlural:entityNamePlural,
                    data:data
                })
                console.log(result);

                let status = document.querySelector('#status')
                if (result.iserror) {
                    status.innerHTML = result.error
                    status.className = 'error'
                    data.innerHTML = ''
                }
                else {
                    status.innerHTML = 'success'
                    status.className = 'success'
                    let message = document.querySelector('#message')
                    message.innerHTML = `<pre>${JSON.stringify(result.rows, null, 2)}</pre>`
                }
            }
        </script>
    </head>
    <body>
        <label>Entity name plural</label>
        <input id="entityNamePlural" value="accounts" />
        <label>Method</label>
        <input id="method" value="POST" />
        <label>Query</label>
        <textarea id="data" rows="20" cols="80"></textarea>

        <button type="button" id="execute" onclick="execute(document)">Send</button>

        <div id="status"></div>
        <div id="message"></div>

        <script type="text/javascript">
            let data = document.querySelector('#data')
            data.value = JSON.stringify({
                name: 'testing ' + new Date().getTime()
            }, null, 2)
        </script>

    </body>
</html>
